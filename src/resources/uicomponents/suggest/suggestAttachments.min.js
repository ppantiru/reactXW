/*
 #set ($paths = {
  'xwiki-selectize': $xwiki.getSkinFile('uicomponents/suggest/xwiki.selectize.js', true)
})
#set ($discard = "#mimetypeimg('' '')")
#set ($discard = $mimetypeMap.put('attachment', ['attach', 'attachment']))
#foreach ($map in [$mimetypeMap, $extensionMap])
  #foreach ($entry in $map.entrySet())
    #set ($discard = $entry.value.set(0, $services.icon.getMetaData($entry.value.get(0))))
    #set ($translationKey = "core.viewers.attachments.mime.$entry.value.get(1)")
    #set ($discard = $entry.value.set(1, $services.localization.render($translationKey)))
  #end
#end
#set ($l10nBundle = {
  'upload': $services.localization.render('web.uicomponents.suggest.attachments.upload'),
  'uploading': $services.localization.render('web.uicomponents.suggest.attachments.uploading', ['{0}']),
  'uploadDone': $services.localization.render('web.uicomponents.suggest.attachments.uploadDone', ['{0}']),
  'uploadFailed': $services.localization.render('web.uicomponents.suggest.attachments.uploadFailed', ['{0}'])
})
#[[*/
'use strict';(function(y,z,r,w,A){require.config({paths:y});define("xwiki-attachments-store",["jquery"],function(e){var n=function(f,d){var c=[z,"rest"];f.getReversedReferenceChain().forEach(function(g){var l=g.type===XWiki.EntityType.DOCUMENT?"page":XWiki.EntityType.getName(g.type);c.push(l+"s",encodeURIComponent(g.name))});f.type===XWiki.EntityType.ATTACHMENT?c.push("metadata"):c.push("attachments");f=e.param(e.extend({prettyNames:!0},d),!0);return c.join("/")+"?"+f};return{get:function(f,d){return e.getJSON(n(f),
d)},upload:function(f,d){var c=new FormData;c.append("file",d);c.append("filename",f.name);var g=e.Deferred();e.post({url:n(f.parent,{createPage:!0}),data:c,processData:!1,contentType:!1,dataType:"json",xhr:function(){var l=e.ajaxSettings.xhr();l.upload&&l.upload.addEventListener("progress",function(p){p.lengthComputable&&g.notify({loaded:p.loaded,total:p.total,percent:Math.round(100*p.loaded/p.total)})},!1);return l}}).done(e.proxy(g,"resolve")).fail(e.proxy(g,"reject"));return g.promise()},create:function(f,
d){var c=(new XWiki.Document(f.parent)).getURL("download")+"/"+encodeURIComponent(f.name),g=f.getReversedReferenceChain().map(function(l){return{type:XWiki.EntityType.getName(l.type),name:l.name,label:l.name}});f={id:XWiki.Model.serialize(f),name:f.name,xwikiRelativeUrl:c,hierarchy:{items:g}};d&&e.extend(f,{mimeType:d.type,file:d});return f}}});define("xwiki-attachments-icon",["jquery"],function(e){var n=function(d){var c=e.Deferred();if("undefined"!==typeof FileReader){var g=new FileReader;g.onload=
function(l){c.resolve(l.target.result)};g.readAsDataURL(d)}return c.promise()},f=function(d,c){c=c.substring(c.lastIndexOf(".")+1);if(r.hasOwnProperty(d))return r[d][0];if(w.hasOwnProperty(c))return w[c][0];d=d.substring(0,d.indexOf("/")+1);return r.hasOwnProperty(d)?r[d][0]:r.attachment[0]};return{getIcon:function(d){if("string"===typeof d.mimeType&&"image/"===d.mimeType.substring(0,6)){var c=d.xwikiRelativeUrl;if("/"===c.substring(0,1)||"http://"===c.substring(0,7))c+=(0>c.indexOf("?")?"?":"&")+
"width=48";var g={iconSetType:"IMAGE",url:c};d.file&&(g.promise=n(d.file).done(function(l){g.url=l}));return g}return f(d.mimeType,d.name)},loadIcon:function(d){var c=e.Deferred();if("IMAGE"===d.icon.iconSetType){var g=new Image;g.onload=function(){c.resolve(d)};g.src=d.icon.url}else c.resolve(d);return c.promise()}}});define("xwiki-attachments-filter",["jquery"],function(e){return{filter:function(n,f){var d=[];"string"===typeof f&&(d=f.split(/\s*,\s*/).filter(function(c){return 0<c.length}));return n.filter(function(c){a:{for(var g=
d,l=0;l<g.length;l++){var p=g[l];if("."===p.substring(0,1)){if(c.name.substring(c.name.length-p.length)===p){c=!0;break a}}else if("string"===typeof c.mimeType&&0<=c.mimeType.indexOf(p)){c=!0;break a}}c=0===g.length}return c})}}});define("xwiki-file-picker",["jquery"],function(e){return{pickLocalFiles:function(n){var f=e.Deferred(),d;e(window).one("focus.filePicker",function(g){d=setTimeout(function(){f.reject()},1E3)});var c=e('<input type="file" class="hidden"/>').prop("multiple",!!n.multiple).appendTo("body");
"string"===typeof n.accept&&c.attr("accept",n.accept.replace(/\/(\s*(,|$))/g,"/*$1"));c.change(function(g){e(window).off("focus.filePicker");clearTimeout(d);f.resolve(this.files);c.remove()}).click();return f.promise()}}});define("xwiki-l10n",["jquery"],function(e){var n=function(f){return function(){var d=f;e.each(arguments,function(c,g){d=d.replace("{"+c+"}",g)});return d}};return function(f){e.each(f,function(d,c){"string"===typeof c&&c.match(/{\d+}/)&&(f[d]=n(c))});return f}});define("xwiki-suggestAttachments",
"jquery xwiki-attachments-store xwiki-attachments-icon xwiki-attachments-filter xwiki-file-picker xwiki-l10n xwiki-selectize".split(" "),function(e,n,f,d,c,g){var l=g(A),p=function(a){return{maxOptions:10,documentReference:a.data("documentReference"),searchScope:a.data("searchScope"),useAttachmentName:!1,uploadAllowed:"true"===a.data("uploadAllowed")||!0===a.data("uploadAllowed"),accept:a.data("accept"),load:function(b,h){var m=this.settings,k=m.searchScope;""!==b||k&&!m.documentReference.hasParent(k)||
(k=m.documentReference);n.get(k,{name:b,types:m.accept,number:m.maxOptions}).then(e.proxy(u,null,m)).done(h).fail(h)},loadSelected:function(b,h){B(b,this.settings).done(h).fail(h)},create:function(b,h){if(0<b.length)return h={},h[this.settings.labelField]=b,h[this.settings.valueField]=b,h;c.pickLocalFiles({accept:this.settings.accept,multiple:1!==this.settings.maxItems}).then(e.proxy(x,null,this)).done(h).fail(h)}}},t=function(a){a.documentReference&&"string"!==typeof a.documentReference||(a.documentReference=
XWiki.Model.resolve(a.documentReference,XWiki.EntityType.DOCUMENT,XWiki.currentDocument.documentReference));a:{var b=a.searchScope||"wiki:"+XWiki.currentWiki;if("string"===typeof b)try{var h=XWiki.Model.resolve(b,null,XWiki.currentDocument.documentReference);break a}catch(m){h=null;break a}h=b}a.searchScope=h;return a},B=function(a,b){a=C(a,b);return n.get(a).then(e.proxy(v,null,b)).then(function(h){return[h]})},u=function(a,b){return e.isArray(b.attachments)?b.attachments.map(e.proxy(v,null,a)):
[]},v=function(a,b){var h=XWiki.Model.resolve(b.id,XWiki.EntityType.ATTACHMENT),m=b.name;a=a.useAttachmentName&&a.searchScope&&a.searchScope.type===XWiki.EntityType.DOCUMENT?h.name:h.parent.equals(a.documentReference)?XWiki.Model.serialize(h.relativeTo(a.documentReference)):XWiki.Model.serialize(h.relativeTo(a.documentReference.getRoot()));return{label:m,value:a,url:b.xwikiRelativeUrl,icon:f.getIcon(b),hint:D(b),data:b}},C=function(a,b){return b.useAttachmentName&&b.searchScope&&b.searchScope.type===
XWiki.EntityType.DOCUMENT?new XWiki.AttachmentReference(a,b.searchScope):XWiki.Model.resolve(a,XWiki.EntityType.ATTACHMENT,b.documentReference)},D=function(a){return a.hierarchy.items.filter(function(b){return"space"===b.type||"document"===b.type&&"WebHome"!==b.name}).map(function(b){return b.label}).join(" / ")},F=function(a){a.get$("wrapper").addClass("async-create");var b=a.canCreate;a.canCreate=function(k){return 0===k.length||b.apply(this,arguments)};var h=a.settings.render.option_create;a.settings.render.option_create=
function(k,q){return 0<k.input.length?h.apply(this,arguments):e('<div class="create upload option"/>').text(l.upload)};var m=a.settings.render.item;a.settings.render.item=function(k){var q=m.apply(this,arguments);k.data&&k.data.upload&&(q.addClass("upload create-"+k.data.upload.status),"running"===k.data.upload.status&&q.css("background","linear-gradient(90deg, #dff0d8 "+k.data.upload.progress.percent+"%, #efefef 0)"));return q};E(a)},x=function(a,b){b=G(b,a.settings);b=d.filter(b,a.settings.accept);
1===a.settings.maxItems&&(b=b.slice(0,1));b=u(a.settings,{attachments:b});a.addOption(b);var h=e.Deferred(),m=h;b.forEach(function(k){a.addItem(k.value);k.icon.promise&&k.icon.promise.done(function(){a.updateOption(k.value,k)});var q=e.proxy(H,null,k,a);m=m.then(q,q)});h.resolve();return b},G=function(a,b){for(var h=[],m=0;m<a.length;m++){var k=a.item(m),q=new XWiki.EntityReference(k.name,XWiki.EntityType.ATTACHMENT,b.documentReference);h.push(n.create(q,k))}return h},H=function(a,b){var h="<em>"+
e("<em/>").text(a.label).html()+"</em>",m=new XWiki.widgets.Notification(l.uploading(h),"inprogress");a.data.upload={status:"pending",progress:{loaded:0,total:a.data.file.size,percent:0}};return I(a.data).then(e.proxy(v,null,b.settings)).then(f.loadIcon).progress(function(k){a.data.upload.status="running";a.data.upload.progress=k;b.updateOption(a.value,a)}).done(function(k){k.data.upload={status:"done"};b.updateOption(k.value,k);m.replace(new XWiki.widgets.Notification(l.uploadDone(h),"done"))}).fail(function(){a.data.upload.status=
"failed";b.updateOption(a.value,a);m.replace(new XWiki.widgets.Notification(l.uploadFailed(h),"error"))})},I=function(a){var b=XWiki.Model.resolve(a.id,XWiki.EntityType.ATTACHMENT);return n.upload(b,a.file)},E=function(a){a.get$("wrapper").on("drag dragstart dragend dragover dragenter dragleave drop",function(b){b.preventDefault();b.stopPropagation()}).on("dragover dragenter",function(){e(this).addClass("is-dragover")}).on("dragleave dragend drop",function(){e(this).removeClass("is-dragover")}).on("drop",
function(b){b=b.originalEvent.dataTransfer;0<b.files.length?x(a,b.files):J(a,b.getData("text/html"))})},J=function(a,b){e(b).find('[data-entity-type="ATTACHMENT"][data-entity-reference]').each(function(){var h=XWiki.Model.resolve(e(this).data("entityReference"),XWiki.EntityType.ATTACHMENT);n.get(h).done(function(m){m=u(a.settings,{attachments:d.filter([m],a.settings.accept)});a.addOption(m);m.forEach(function(k){a.addItem(k.value)})})})},K=function(a){var b=a.settings.render.option;a.settings.render.option=
function(h){var m=b.apply(this,arguments),k=m.find(".xwiki-selectize-option-hint");a.settings.searchScope.type===XWiki.EntityType.DOCUMENT?k.remove():1===k.length&&(e('<div class="xwiki-selectize-option-label-wrapper"/>').append(m.find(".xwiki-selectize-option-label")).append(k).appendTo(m),m.find(".xwiki-selectize-option-icon-wrapper").addClass("pull-left"));return m}};e.fn.suggestAttachments=function(a){return this.each(function(){var b=e.extend(p(e(this)),a);e(this).xwikiSelectize(t(b));this.selectize.settings.uploadAllowed&&
F(this.selectize);K(this.selectize)})}});define("xwiki-attachmentResourcePicker",["jquery","xwiki-suggestAttachments"],function(e){var n=function(){f(this.selectize);var d=this.selectize.settings.loadSelected;this.selectize.settings.loadSelected=function(c,g){var l=this.options[c];l&&l.data?g(c):d.apply(this,arguments)}},f=function(d){Object.keys(d.options).forEach(function(c){var g=d.options[c];a:{var l=d.settings.supportedResourceTypes;var p=c.indexOf(":");if(0<=p){var t=c.substring(0,p).toLowerCase();
if(0<=l.indexOf(t)){l={type:t,reference:c.substring(p+1)};break a}}l={type:"attach",reference:c}}"attach"===l.type?c!==l.reference&&(g[d.settings.valueField]=l.reference,d.updateOption(c,g)):g.data||(g.data.resourceReference=l)})};e.fn.pickAttachmentResource=function(d){return this.on("initialize",n).each(function(){var c=e.extend({supportedResourceTypes:e(this).data("supportedResourceTypes")||"attach, data, url, path, unc"},d);"string"===typeof c.supportedResourceTypes&&(c.supportedResourceTypes=
c.supportedResourceTypes.split(/\s*,\s*/).filter(function(g){return 0<g.length}).map(function(g){return g.toLowerCase()}));e(this).suggestAttachments(c)})}});require(["jquery","xwiki-suggestAttachments","xwiki-attachmentResourcePicker","xwiki-events-bridge"],function(e){var n=function(f,d){f=e(d&&d.elements||document);f.find(".suggest-attachments").suggestAttachments();f.find(".pick-attachment-resource").pickAttachmentResource()};e(document).on("xwiki:dom:updated",n);e(n)})}).apply("]]#",$jsontool.serialize([$paths,
$request.contextPath,$mimetypeMap,$extensionMap,$l10nBundle]));

//# sourceMappingURL=suggestAttachments.min.js.map
