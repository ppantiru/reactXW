'use strict';var XWiki=function(g){(g.widgets=g.widgets||{}).SuggestPicker=Class.create({options:{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!0,showClearTool:!0,inputType:"hidden",listInsertionElement:null,listInsertionPosition:"after",acceptFreeText:!1,onItemAdded:Prototype.emptyFunction,separator:","},initialize:function(a,b,d){this.removeItem=this.removeItem.bindAsEventListener(this);this.checkboxChanged=this.checkboxChanged.bindAsEventListener(this);this.options=Object.extend(Object.clone(this.options),
d||{});this.input=$(a);this.suggest=b;this.inputName=this.input.name;this.options.acceptFreeText?this.input.addClassName("accept-value"):this.input.name+="__suggested";this.suggest.options.callback=this.acceptSuggestion.bind(this);this.list=new Element("ul",{"class":"accepted-suggestions"});var c;this.options.listInsertionElement&&(c="string"===typeof this.options.listInsertionElement?this.input.up().down(this.options.listInsertionElement):this.options.listInsertionElement);c||(c=this.input);a={};
a[this.options.listInsertionPosition]=this.list;c.insert(a);this.options.showClearTool&&(this.clearTool=(new Element("a",{href:"#clearSelection","class":"clear-tool",title:"$services.localization.render('core.widgets.suggestPicker.deleteAll.tooltip')"})).update("$services.localization.render('core.widgets.suggestPicker.deleteAll')"),this.clearTool.hide().observe("click",this.clearAcceptedList.bindAsEventListener(this)),this.list.insert({after:this.clearTool}));this.initializeSelection()},initializeSelection:function(){this.input.readOnly=
!0;this.input.addClassName("loading");this.loadSelectedValue(this.input.value.split(this.options.separator),0)},loadSelectedValue:function(a,b){if(b>=a.length)this.input.readOnly=!1,this.input.value="",this.input.removeClassName("loading");else if(""==a[b].strip())this.loadSelectedValue(a,b+1);else{var d=!1,c=0;this.input.value=a[b];this.suggest.doAjaxRequests(-1,{parameters:{exactMatch:!0},onSuccess:function(e){if(!d){e=this.suggest.parseResponse(e,this.suggest.sources[c])||[];for(var f=0;f<e.length;f++)if(this.matchesSelectedValue(a[b],
e[f])){d=!0;e[f].value=a[b];this.addItem(e[f]);break}}}.bind(this),onComplete:function(e){e.request.options.defaultValues.onComplete(e);++c>=this.suggest.sources.length&&(d||this.addItem(this.getDefaultSuggestion(a[b])),this.loadSelectedValue(a,b+1))}.bind(this)})}},matchesSelectedValue:function(a,b){return a==b.value},getDefaultSuggestion:function(a){return{id:a,value:a,info:a}},acceptSuggestion:function(a){this.acceptAlreadyAddedItem(a.id||a.value)||this.addItem(a);this.input.value=""},removeItem:function(a){this.input.readOnly||
this.input.disabled||(a=a.findElement("li"),a.remove(),this.notifySelectionChange(a),this.updateListTools(),this.input.activate())},clearAcceptedList:function(a){a&&a.stop();this.list.update("");this.notifySelectionChange();this.updateListTools();this.input.activate()},checkboxChanged:function(a){a=a.findElement("li");this.notifySelectionChange(a)},acceptAlreadyAddedItem:function(a){return(a=this.list?this.list.down('input[id="'+this.getInputId(a).replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]'):$(this.getInputId(a)))?
(a.checked=!0,this.notifySelectionChange(a.up("li")||a),!0):!1},addItem:function(a){a&&(a=this.displayItem(a),this.list.insert(a),this.options.onItemAdded(a.down("input")),this.notifySelectionChange(a),this.updateListTools())},displayItem:function(a){var b=this.createItemInput(a),d=new Element("li"),c=(new Element("label",{"for":b.id})).insert({bottom:b});this.options.showKey&&(c.insert({bottom:(new Element("span",{"class":"key"})).update("["+b.value.escapeHTML()+"]")}),c.insert({bottom:(new Element("span",
{"class":"sep"})).update(" ")}));c.insert({bottom:(new Element("span",{"class":"value"})).update(a.value.escapeHTML())});d.insert(c);this.options.showDeleteTool&&d.insert(this.createDeleteTool());this.options.showTooltip&&a.info&&d.appendChild((new Element("div",{"class":"tooltip"})).update(a.info));return d},createItemInput:function(a){a={type:this.options.inputType,name:this.inputName,id:this.getInputId(a.id||a.value),value:a.value||a.id};"checkbox"==this.options.inputType&&(a.checked="checked");
a=new Element("input",a);a.observe("change",this.checkboxChanged);return a},createDeleteTool:function(){var a=(new Element("span",{"class":"delete-tool",title:"$services.localization.render('core.widgets.suggestPicker.delete.tooltip')"})).update("&times;").observe("click",this.removeItem);a.insert({top:(new Element("span",{"class":"hidden"})).update("[")});a.insert({bottom:(new Element("span",{"class":"hidden"})).update("]")});return a},updateListTools:function(){var a=!this.input.readOnly&&!this.input.disabled;
this.clearTool&&(a&&1<this.list.childElements().length?this.clearTool.show():this.clearTool.hide());a&&this.options.enableSort&&1<this.list.childElements().length&&"undefined"!=typeof Sortable&&(Sortable.create(this.list),this.list.addClassName("sortable"))},notifySelectionChange:function(a){Event.fire(document,"xwiki:multisuggestpicker:selectionchanged",{trigger:this.input,fieldName:this.inputName,changedElement:a})},getInputId:function(a){return this.inputName+"_"+a},detach:function(){this.clearTool&&
this.clearTool.stopObserving("click").remove();this.list&&this.list.remove();this.input.name=this.inputName;this.input.removeClassName("accept-value")}});return g}(XWiki||{});

//# sourceMappingURL=suggestPicker.min.js.map
