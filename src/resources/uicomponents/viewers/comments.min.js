'use strict';var XWiki=function(d){function k(){return new l.Comments}var l=d.viewers=d.viewers||{};l.Comments=Class.create({commentNumberRegex:/.+_(\d+)/,xcommentSelector:".xwikicomment",commentPlaceHolderSelector:"commentFormPlaceholder",extractCommentNumber:function(a){return a.id.match(this.commentNumberRegex)[1]},hasCommentNumber:function(a){return 1<a.id.match(this.commentNumberRegex).size()},initialize:function(){var a=$("commentscontent");a&&this.startup();$("Commentstab")?this.container=
$("Commentspane"):a&&(this.container=a.wrap("div",{id:"Commentspane"}));this.addTabLoadListener()},startup:function(){this.formDisplayed=!1;this.loadIDs();this.getForm();this.addReplyListener();this.addEditListener();var a=$("openCommentForm");a&&a.observe("click",function(b){b.stop();this.displayHiddenForm();this.reloadEditor({callback:function(){this.getForm();this.addSubmitListener(this.form);this.addCancelListener();this.addPreview(this.form)}.bind(this)})}.bind(this))},getForm:function(){var a=
$("commentform");this.form=a?a.up("form"):void 0},displayHiddenForm:function(){if(!this.formDisplayed){var a=$(this.commentPlaceHolderSelector);a&&a.removeClassName("hidden");(a=$("openCommentForm"))&&a.remove();this.formDisplayed=!0}},loadIDs:function(){$$(this.xcommentSelector).each(function(a){var b=a.id;a._x_number=b.substring(b.lastIndexOf("_")+1)-0})},addEditListener:function(){$$(this.xcommentSelector).each(function(a){(a=a.down("a.edit"))&&a.observe("click",function(b){a.blur();b.stop();this.displayHiddenForm();
a.disabled||(a._x_editForm?(b=a.up(this.xcommentSelector),b.hide(),b=this.extractCommentNumber(b),this.reloadEditor({commentNbr:b,callback:function(){this.getForm()}.bind(this)}),a._x_editForm.show()):new Ajax.Request(a.readAttribute("href").replace("viewer=comments","xpage=xpart&vm=commentsinline.vm"),{onCreate:function(){a.disabled=!0;a._x_notification=new d.widgets.Notification("$services.localization.render('core.viewers.comments.editForm.fetch.inProgress')","inprogress")},onSuccess:function(c){this.editing&&
this.cancelEdit(!1,this.editing);var e=a.up(this.xcommentSelector);e.insert({before:c.responseText});a._x_editForm=e.previous();this.addSubmitListener(a._x_editForm);c=a.readAttribute("href").match(/number=(\d+)/)[1];$(this.commentPlaceHolderSelector).hide();this.reloadEditor({commentNbr:c,callback:function(){this.addPreview(a._x_editForm);a._x_editForm.down("a.cancel").observe("click",this.cancelEdit.bindAsEventListener(this,a));e.hide();a._x_notification.hide();this.editing=a}.bind(this)})}.bind(this),
onFailure:function(c){var e=c.statusText;if(""==c.statusText||12031==c.status)e="Server not responding";a._x_notification.replace(new d.widgets.Notification("$services.localization.render('core.viewers.comments.editForm.fetch.failed')"+e,"error"))}.bind(this),on0:function(c){c.request.options.onFailure(c)},onComplete:function(){a.disabled=!1}}))}.bindAsEventListener(this))}.bind(this))},cancelEdit:function(a,b){a&&a.stop();a=b.up(this.xcommentSelector);b._x_editForm.hide();var c="XWiki.XWikiComments_"+
this.extractCommentNumber(a)+"_comment";this.destroyEditor("[name='"+c+"']",c);a.show();$(this.commentPlaceHolderSelector).show();this.reloadEditor({callback:function(){this.getForm();this.addSubmitListener(this.form);this.addCancelListener();this.addPreview(this.form)}.bind(this)});this.cancelPreview(b._x_editForm);this.editing=!1},addReplyListener:function(){this.form?$$(this.xcommentSelector).each(function(a){this.addReplyListenerToComment(a)}.bind(this)):$$(this.xcommentSelector+" a.commentreply").each(function(a){a.hide()})},
addReplyListenerToComment:function(a){(a=a.down("a.commentreply"))&&a.observe("click",function(b){a.blur();b.stop();this.displayHiddenForm();this.getForm();this.form.up(".commentthread")&&this.form.up(".commentthread").previous(this.xcommentSelector).down("a.commentreply").show();a.up(this.xcommentSelector).next(".commentthread").insert({top:this.form});this.reloadEditor({callback:function(){this.getForm();this.addSubmitListener(this.form);this.addCancelListener();this.addPreview(this.form);this.form["XWiki.XWikiComments_replyto"].value=
a.up(this.xcommentSelector)._x_number;this.form["XWiki.XWikiComments_comment"].value="";this.form["XWiki.XWikiComments_comment"].focus();a.hide()}.bind(this)})}.bindAsEventListener(this))},addSubmitListener:function(a){a&&!a._has_event&&(a._has_event=!0,a.down("input[type='submit']").observe("click",function(b){b.stop();document.fire("xwiki:actions:beforeSave");if(""!=a.down("textarea").value){b=new Hash(a.serialize(!0));b.set("xredirect",window.docgeturl+"?xpage=xpart&vm=commentsinline.vm&skin="+
encodeURIComponent(d.skin));b.set("xpage","xpart");b.set("vm","commentsinline.vm");b.set("skin",d.skin);var c=$H(a.action.toQueryParams());b.keys().each(c.unset.bind(c));c=a.action.replace(/\?.*/,"?"+c.toQueryString());b.unset("action_cancel");a._x_notification=new d.widgets.Notification("$services.localization.render('core.viewers.comments.add.inProgress')","inprogress");a.disable();this.requestSucceeded=!1;new Ajax.Request(c,{method:"post",parameters:b,onSuccess:function(){this.requestSucceeded=
!0;this.editing=!1}.bind(this),onFailure:function(e){var f=e.statusText;if(""==e.statusText||12031==e.status)f="Server not responding";a._x_notification.replace(new d.widgets.Notification("$services.localization.render('core.viewers.comments.add.failed')"+f,"error"))}.bind(this),on0:function(e){e.request.options.onFailure(e)},onComplete:function(e){a.enable();var f=a.down(".xwikicomment"),g="XWiki.XWikiComments_comment";void 0!==f&&this.hasCommentNumber(f)&&(g="XWiki.XWikiComments_"+this.extractCommentNumber(f)+
"_comment");this.destroyEditor("[name='"+g+"']",g);this.requestSucceeded&&(this.container.update(e.responseText),e=$("submittedcomment"),f="",e&&(f=e.value,e.remove(),this.formDisplayed=!1),this.displayHiddenForm(),this.reloadEditor({content:f,callback:function(){this.getForm();this.addSubmitListener(this.form);this.addCancelListener();this.addPreview(this.form)}.bind(this)}),document.fire("xwiki:docextra:loaded",{id:"Comments",element:this.container}),this.container.fire("xwiki:captcha:reloaded"),
a._x_notification.replace(new d.widgets.Notification("$services.localization.render('core.viewers.comments.add.done')","done")))}.bind(this)})}}.bindAsEventListener(this)))},addCancelListener:function(){this.form&&(this.initialLocation=new Element("span",{className:"hidden"}),$("_comments").insert(this.initialLocation),this.form.down("a.cancel").observe("click",this.resetForm.bindAsEventListener(this)))},addPreview:function(a){if(a&&d.hasEdit&&"text"===a.down("input[name='defaultEditorId']").value){var b=
"$xwiki.getURL('__space__.__page__', 'preview')".replace("__space__",encodeURIComponent(d.currentSpace)).replace("__page__",encodeURIComponent(d.currentPage));a.commentElt=a.down("textarea");var c=a.down("input[type=submit]").up("div");a.previewButton=(new Element("span",{"class":"buttonwrapper"})).update(new Element("input",{type:"button","class":"button",value:"$services.localization.render('core.viewers.comments.preview.button.preview')"}));a.previewButton._x_modePreview=!1;var e=a.previewButton.down("input").value;
(e=c.down("input[value='"+e+"']"))&&e.remove();c.insert({top:a.previewButton});a.previewButton.observe("click",function(){if(a.previewButton._x_modePreview||a.previewButton.disabled)this.cancelPreview(a);else{a.previewButton.disabled=!0;var f=new d.widgets.Notification("$services.localization.render('core.viewers.comments.preview.inProgress')","inprogress");new Ajax.Request(b,{method:"post",parameters:{xpage:"plain",sheet:"",content:a.down("textarea").value,form_token:a.form_token.value,restricted:"true"},
onSuccess:function(g){var h=a.commentElt.up(this.xcommentSelector),m;void 0!==h&&this.hasCommentNumber(h)&&(m=this.extractCommentNumber(h));this.doPreview(g.responseText,a,m);f.hide()}.bind(this),on400:function(g){this.doPreview("&nbsp;",a);f.hide()}.bind(this),onFailure:function(g){var h=g.statusText;if(""==g.statusText||12031==g.status)h="Server not responding";f.replace(new d.widgets.Notification("$services.localization.render('core.viewers.comments.preview.failed')"+h,"error"))},on0:function(g){g.request.options.onFailure(g)},
onComplete:function(g){a.previewButton.disabled=!1}.bind(this)})}}.bindAsEventListener(this))}},doPreview:function(a,b,c){require(["jquery"],function(e){b.previewButton._x_modePreview=!0;var f=".commenteditor";c&&(f+="-"+c);f=e(b).find(f);0===e(b).find(".commentPreview").size()&&f.before('<div class="commentcontent commentPreview" style="display: none;"></div>');var g=e(b).find(".commentcontent.commentPreview");g.html(a);g.show();f.hide();e(b.previewButton).find("input").val("$services.localization.render('core.viewers.comments.preview.button.back')")}.bind(this))},
cancelPreview:function(a){require(["jquery"],function(b){a.previewButton&&(a.previewButton._x_modePreview=!1,b(a.previewButton).find("input").val("$services.localization.render('core.viewers.comments.preview.button.preview')"));var c=b(a).find(".commentPreview");c&&(c.hide(),c.empty());(b=b(a).find(".commenteditor"))&&b.show()}.bind(this))},resetForm:function(a){a&&a.stop();this.getForm();this.form.up(".commentthread")&&(this.form.up(".commentthread").previous(this.xcommentSelector).down("a.commentreply").show(),
this.initialLocation.insert({after:this.form}));this.form["XWiki.XWikiComments_replyto"].value="";this.reloadEditor();this.cancelPreview(this.form)},addTabLoadListener:function(a){a=function(b){"Comments"==b.memo.id&&this.startup()}.bindAsEventListener(this);document.observe("xwiki:docextra:loaded",a)},destroyEditor:function(a,b){require(["jquery","xwiki-events-bridge"],function(c){c(document).trigger("xwiki:actions:cancel");0<c(a).size()&&c(a).parent(".commenteditor").empty()})},reloadEditor:function(a){var b=
".commenteditor";a=a||{};var c=a.commentNbr,e=a.callback,f="XWiki.XWikiComments_comment";c&&(f="XWiki.XWikiComments_"+c+"_comment",b=b+"-"+c);var g=a.content||{};this.destroyEditor("[name='"+f+"']",f);require(["jquery","xwiki-events-bridge"],function(h){0<h(".commenteditor").size()&&h.post((new d.Document).getURL("get")+"?"+h.param({xpage:"xpart",vm:"commentfield.vm",number:c,name:f,content:g}),function(m){var n=h(b);n.empty();n.append(m);n.show();h(document).trigger("xwiki:dom:updated",{elements:n.toArray()});
0<h("#commentCaptcha").size()&&h("#commentCaptcha").first().css("display","block");e&&e()})})}});d.domIsLoaded&&k()||document.observe("xwiki:dom:loaded",k);return d}(XWiki||{});
require(["jquery"],function(d){d(document).on("show.bs.modal","#permalinkModal",function(k){k=d(k.relatedTarget).prop("href");d(this).find(".form-control").val(k)});d(document).on("shown.bs.modal","#permalinkModal",function(){d(this).find(".form-control").focus()});d(document).on("click","#permalinkModal input.btn-primary",function(){window.location=d("#permalinkModal").find(".form-control").val()})});
require(["jquery","xwiki-events-bridge"],function(d){d(document).on("show.bs.modal","#deleteModal",function(a){d(this).data("relatedTarget",d(a.relatedTarget))});d(document).on("click","#deleteModal input.btn-danger",function(){var a=d("#deleteModal").data("relatedTarget"),b;d.ajax({url:a.prop("href"),beforeSend:function(){a.prop("disabled",!0);b=new XWiki.widgets.Notification("$services.localization.render('core.viewers.comments.delete.inProgress')","inprogress")},success:function(){var c=a.closest(".xwikicomment"),
e=c.nextAll(".commentthread").find("form");e.length&&e.find(".cancel")[0].click();c.replaceWith(k("$services.localization.render('core.viewers.comments.commentDeleted')"));l();b.replace(new XWiki.widgets.Notification("$services.localization.render('core.viewers.comments.delete.done')","done"));c.hasClass("annotation")&&d(document).trigger("xwiki:annotation:tab:deleted")},error:function(){a.prop("disabled",!1);b.replace(new XWiki.widgets.Notification("$services.localization.render('core.viewers.comments.delete.failed')",
"error"))}})});var k=function(a){var b=new Element("div",{"class":"notification"});b.update(a);return b},l=function(){var a=d("#Commentstab").find(".itemCount"),b=d(".xwikicomment").size();a&&a.text("$services.localization.render('docextra.extranb', ['__number__'])".replace("__number__",b));d("#tmComment").length&&(d("#tmComment")[0].normalize(),a=" $services.localization.render('docextra.comments') $services.localization.render('docextra.extranb', ['__number__'])".replace("__number__",b),d("#tmComment").contents().last()[0].nodeValue=
a)};d(document).on("xwiki:docextra:loaded",function(a,b){"Comments"===b.id&&l()})});

//# sourceMappingURL=comments.min.js.map
